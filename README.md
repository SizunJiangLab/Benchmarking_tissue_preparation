### Benchmarking Tissue Preparation

#### Table of Contents

- [Project Overview](#project-overview)
- [Environment](#environment)
- [Data and Metadata](#data-and-metadata)
- [Quickstart](#quickstart)
- [Selecting a Configuration](#selecting-a-configuration)
- [Outputs](#outputs)
- [Complementary Workflows](#complementary-workflows)
- [Utilities](#utilities)
- [Directory Structure](#directory-structure)
- [Contributors](#contributors)

## Project Overview

This repository hosts analysis workflows to benchmark tissue preparation and staining conditions across multiple platforms. It provides publication-ready figures and statistics across many datasets and sources.

Primary workflows:

- MESMER data-slide analysis: `MESMER_dataSlide_workflow.R`
- CellXpress data-slide analysis: `cellXpress_dataSlide_workflow.R`
- Signal-to-Noise Ratio (SNR) analysis: `MESMER_SignalNoise_workflow.R`
- Optional spatial analysis: `balagan_analysis.R`

## Environment

Tested on:

- MacOS 14.6.1
- Red Hat Enterprise Linux 8.10 (Ootpa)

Recommended versions:

- Python: 3.9.12+ (required for SNR preprocessing, optional for other segmentation tasks)
- R: >= 4.3.2

Install dependencies:

- Python (required for SNR preprocessing workflow, optional for other segmentation tasks)

```bash
pip install -r ./requirements.txt
pip install deepcell  # Required for MESMER segmentation in SNR preprocessing
```

- R packages

```r
install.packages(c(
  "dplyr", "tidyverse", "matrixStats", "ggcorrplot", "ggpubr", "tidyr",
  "rstatix", "readr", "svglite", "devtools", "qs"
))

devtools::install_github("immunogenomics/presto")

# Optional: to run balagan_analysis.R
devtools::install_github("PierreBSC/Balagan")
```

## Data and Metadata

**Important**: The raw data files are not included in this GitHub repository. Data will be made available on Zenodo, and download links will be provided here once available.

To use the workflows, download the data from Zenodo and place it under:

- `./data_mesmer/` (MESMER workflow)
- `./data_cellXpress/` (CellXpress workflow)

For detailed information about data organization, file formats, and structure, see:

- [data_mesmer/README.md](data_mesmer/README.md) - MESMER segmentation data documentation
- [data_cellXpress/README.md](data_cellXpress/README.md) - CellXpress segmentation data documentation

### Data Structure Overview

MESMER data structure:

```
./data_mesmer/
  BIDMC/                    # CSVs per Source
  Roche/
  Stanford/
  ...
  Slide_metadata.csv
  Slide_compare_pairs.csv   # auto-generated by build_compare_pairs.R
  Slide_exclude_markers.csv
  Slide_remove_markers.csv
  Registered_Report_marker_sequence.csv
  Slide_exclude_cells.csv   # optional
```

CellXpress data structure:

```
./data_cellXpress/
  BIDMC/                    # CSVs per Source
  Roche/
  Stanford/
  ...
  Slide_metadata.csv
  Slide_compare_pairs.csv
  Slide_exclude_markers.csv
  Slide_remove_markers.csv
  Registered_Report_marker_sequence.csv
```

### Key Metadata Files

- Slide_metadata.csv

  - Maps filenames to source, type, FOV, and sample name
  - Columns: `Filename, Source, Type, FOV, Name`
  - Example:
    ```
    Filename,Source,Type,FOV,Name
    dataScaleSize_slide10_FOV1.csv,Roche,dataScaleSize,FOV1,Roche_10
    dataScaleSize_slide10_FOV2.csv,Roche,dataScaleSize,FOV2,Roche_10
    ```

- Slide_compare_pairs.csv

  - Defines pairs used for Cohen’s d and Wilcoxon tests
  - Auto-generated by `build_compare_pairs.R` from unique `Name` per `Source` where `Type == dataScaleSize`
  - Columns: `Source, Compare1, Compare2`

- Slide_exclude_markers.csv

  - Markers to gray out (non-working) for specific sources
  - Columns: `Source, Exclude_type, Exclude_value`
  - Example:
    ```
    Source,Exclude_type,Exclude_value
    Roche,Marker,CD68
    Roche,Marker,Pan-Cytokeratin
    ```

- Slide_remove_markers.csv

  - Markers to remove entirely before analysis
  - Columns: `Source, Exclude_type, Exclude_value`

- Registered_Report_marker_sequence.csv

  - One-column CSV specifying desired marker order

- Slide_exclude_cells.csv (optional)
  - Per-slide cell exclusions used by helper logic
  - Columns: `Source, Slide, Marker` (Marker name normalization removes `.` and `-`)

## Quickstart

Standard end-to-end for MESMER and CellXpress:

1. **Download data from Zenodo** (links will be provided)

   - Download and extract the data to `./data_mesmer/` and/or `./data_cellXpress/` directories
   - See [data_mesmer/README.md](data_mesmer/README.md) and [data_cellXpress/README.md](data_cellXpress/README.md) for detailed data organization

2. **Update metadata and marker lists** (if needed)

- Ensure these files are current: `Slide_metadata.csv`, `Slide_exclude_markers.csv`, `Slide_remove_markers.csv`, `Registered_Report_marker_sequence.csv`.

3. Build comparison pairs for statistical testing

```bash
Rscript build_compare_pairs.R
```

- Writes `./data_mesmer/Slide_compare_pairs.csv` by enumerating all pairs of `Name` per `Source` for `Type == dataScaleSize`.

4. Select a configuration to run

- Edit `MESMER_dataSlide_workflow.R` and set `current_config_name` to your target dataset.

```r
current_config_name <- "BIDMC_all"  # choose your config
current_config <- configurations[[current_config_name]]
```

5. Run the workflow

```bash
Rscript MESMER_dataSlide_workflow.R
```

- The script caches inputs in `./qsave_input/<CONFIG>_input.qsave` for faster re-runs.
- Runtime estimate: depends on number of slides per configuration. Largest (BIDMC) typically ~20 minutes on a laptop; others usually ~5 minutes. CellXpress is similar in scale to MESMER.

## Selecting a Configuration

Set `current_config_name` to one of the following (see script for the full list):

- Adjusted_RareCyte_LN_all, Adjusted_RareCyte_TMA_all
- ASTAR_COMET_CRC_all, ASTAR_COMET_Tonsil_all
- BIDMC_all, BIDMC_DLBCL_all, BIDMC_Tonsil_all, BIDMC_Tonsil_compare_all, BIDMC_subset
- Double_all
- Novartis_Lung_Cancer_all, Novartis_Tonsil_all
- Roche_all, Roche_intestine_all, Roche_Tonsil_all
- Stanford_all, Stanford_Tonsil_all, Stanford_scan1_all
- Stanford_MIBI_Colon_all, Stanford_MIBI_Liver_all
- Stanford_MIBI_LymphNode_Tile1_all, \_Tile2_all, \_Tile3_all, \_Tile4_all
- Stanford_MIBI_LymphNode_pooled_all
- Stanford_OSCC_all
- Stanford_RareCyte_LN_all, Stanford_RareCyte_TMA_all
- UKentucky_SCC_all, UKentucky_Tonsil_all

Notes:

- Standard loading uses `load_mesmer_data()` (FOV-based). `Stanford_MIBI_LymphNode_pooled_all` uses `load_mesmer_data_pooled()` to pool tiles.

## Outputs

Outputs are written to a per-configuration folder under the project root, e.g. `./out_Stanford_all/`.

Key files:

- Visualizations

  - `Arcsinh_transformed_Hoechst_normalised_density_plots.svg`
  - `Heatmap_mean_white_to_red.svg`
  - `Heatmap_mean_zscore_blue_white_red.svg`
  - `Heatmap_CV_zscore_purple_green.svg`
  - `Heatmap_CV_raw_values.svg` (raw CVs annotated)
  - Score heatmap and average score barplot for conditions

- Statistics

  - `kruskal_pvals.csv` (Kruskal–Wallis)
  - `wilcox_results.csv` (Wilcoxon between pairs)
  - `cohens_d_results.csv` and `large_effect_results.csv`

- Processed data

  - `mean_values.csv`, `mean_z_scores.csv`
  - `cv_values.csv`, `cv_z_scores.csv`

- Scoring system exports

  - `condition_summary.csv` (average scores, working markers count, ranks)
  - `marker_summary.csv`
  - `total_z_ranks.csv`
  - `cv_values_long.csv`, `cv_z_scores_long.csv`
  - `cv_ranks_and_scores.csv`, `cv_ranks_wide.csv`, `cv_scores_wide.csv`

- Configuration and provenance
  - `config_summary.csv`, `processed_files.csv`, `comparison_pairs.csv`
  - `session_info.txt`

## Complementary Workflows

- SNR workflow (MESMER sources with SNR raw data: BIDMC, Roche, Stanford)

  0. **Preprocess images and extract signal-to-noise ratios (Python)**

     Before running the R SNR visualization workflow, you must first process the raw qptiff images to extract signal ratios. This step performs image cropping, MESMER segmentation, single-cell feature extraction, and calculates signal-to-noise ratios for each marker.

     ```bash
     python crop_mesmer_featureextraction_signaltonoise.py
     ```

     **Prerequisites:**

     - Python 3.9+ with dependencies: `pip install -r requirements.txt`
     - DeepCell MESMER installed: `pip install deepcell`
     - Raw qptiff image files in the specified data folder

     **Configuration:**

     - Edit the script to set:
       - `data_folder`: Path to folder containing `.qptiff` files
       - `output_folder`: Where to save processed outputs
       - `crop_coords_dict`: Dictionary mapping slide numbers to crop coordinates `(x_min, x_max, y_min, y_max)`
       - `markers`: List of marker names in channel order

     **Outputs:**

     - `extracted_features/`: Single-cell feature CSV files (`data_slide{key}_FOV1.csv`, `dataScaleSize_slide{key}_FOV2.csv`)
     - `Individualtiff_slide{key}_FOV1/`: Individual TIFF files per marker and `signal_ratios_slide{key}_FOV2.csv` with SNR metrics
     - `MESMER_outputs/`: Segmentation masks and overlays

     **Key outputs for R workflow:**

     - Signal ratio CSV files: `signal_ratios_slide{key}_FOV2.csv` containing columns:
       - `Marker`: Marker name
       - `signal_invsout_DAPInorm`: DAPI-normalized signal ratio
       - `signal_invsout_areanorm`: Area-normalized signal ratio
       - `Normalized_signal_invsout`: DAPI + area normalized ratio (used by R workflow)

     **Note:** Ensure these signal ratio files are referenced in `Slide_metadata.csv` with `Type == "signal_ratios"` for the R workflow to find them.

  1. Normalize raw SNR cell counts

     ```bash
     Rscript process_cell_counts.R
     ```

  2. Generate SNR figures and summaries

     ```bash
     Rscript MESMER_SignalNoise_workflow.R
     ```

  - Features: Hoechst normalization, SNR heatmaps, mean SNR barplots
  - Outputs (examples): `SNR_heatmap_threshold.svg`, `SNR_heatmap_purpleyellow.svg`, `SNR_barplot_means.svg`, `processed_snr_data.csv`, `marker_mean_snr.csv`
  - Runtime estimate: Python preprocessing depends on image size and number of slides (typically minutes to hours per slide). R workflow: a few seconds per run.

- CellXpress workflow

  - Script: `cellXpress_dataSlide_workflow.R`
  - Input location: `./data_cellXpress/` (mirrors MESMER structure)
  - Produces analogous density plots and summaries

- Balagan spatial analysis (advanced, optional)

  - **Location**: `./balagan_analysis/` folder with complete workflow
  - **Purpose**: Quantifies spatial heterogeneity and subsampling efficiency using 100 independent Balagan runs
  - **Key Metrics**:
    - Tau (τ): Sampling efficiency - how quickly subsampling recovers all cell clusters
    - Alpha (α): Spatial heterogeneity - power-law relationship between FOV size and cluster discovery
  - **Install**: `devtools::install_github("PierreBSC/Balagan")`
  - **Documentation**: See [balagan_analysis/README.md](balagan_analysis/README.md) for complete workflow
  - **Runtime**: ~24-30 hours for full 100-run analysis
  - **Outputs**: Stability metrics, rank heatmaps, correlation plots, quadrant classifications

## Utilities

- `check_norm_column.R`: Verifies that required normalization columns exist in inputs.
- `process_cell_counts.R`: Normalizes and aggregates cell counts for SNR analysis prior to `MESMER_SignalNoise_workflow.R`.
- `crop_mesmer_featureextraction_signaltonoise.py`: Python script for preprocessing qptiff images, performing MESMER segmentation, extracting single-cell features, and calculating signal-to-noise ratios. Required before running the SNR visualization workflow in R.
- `pylibs/tissue_preparation.py`: Python utility library providing functions for reading qtiff images, generating nuclear/membrane channels, running MESMER segmentation, and extracting single-cell features. Used by `crop_mesmer_featureextraction_signaltonoise.py`.

## Manual Annotation

Manual clustering and annotation are maintained in `./manual_annotation/` and are separate from the R-based workflows above.

- See [manual_annotation/DOCUMENTATION.md](manual_annotation/DOCUMENTATION.md) for the complete Python-based pipeline and SLURM submission scripts.

## Directory Structure

Representative layout in this repository:

```
.
├── data_mesmer/
│   ├── README.md                          # Detailed data documentation
│   ├── <Source folders with CSV files>    # Download from Zenodo
│   ├── Slide_metadata.csv
│   ├── Slide_compare_pairs.csv
│   ├── Slide_exclude_markers.csv
│   ├── Slide_remove_markers.csv
│   └── Registered_Report_marker_sequence.csv
├── data_cellXpress/
│   ├── README.md                          # Detailed data documentation
│   ├── <Source folders with CSV/QS files> # Download from Zenodo
│   ├── Slide_metadata.csv
│   ├── Slide_compare_pairs.csv
│   ├── Slide_exclude_markers.csv
│   ├── Slide_remove_markers.csv
│   └── Registered_Report_marker_sequence.csv
├── qsave_input/
│   └── <CONFIG>_input.qsave
├── manual_annotation/
│   ├── 01_clustering.py
│   ├── 02_annotation.py
│   ├── 03_phenotype_map.py
│   ├── 04_stacked_bar_plots.py
│   ├── 05_enrichment_plots.py
│   └── DOCUMENTATION.md
├── balagan_analysis/
│   ├── 00_run_100_balagan_analyses.R
│   ├── 01_check_consistency_and_calc_alpha.R
│   ├── 02_plot_stable_rank_heatmaps.R
│   ├── 03_plot_subsampling_curves.R
│   ├── 04_plot_rank_correlations.R
│   ├── 05_calculate_tau_rank_stability.R
│   ├── 06_correlation_analysis.R
│   ├── 07_regenerate_scatter_heatmap_plots.R
│   └── README.md
├── out_<CONFIG>_.../
│   └── [output CSVs/SVGs]
├── MESMER_dataSlide_workflow.R
├── MESMER_SignalNoise_workflow.R
├── cellXpress_dataSlide_workflow.R
├── build_compare_pairs.R
├── balagan_analysis.R
├── helper.R
├── crop_mesmer_featureextraction_signaltonoise.py
├── pylibs/
│   ├── __init__.py
│   └── tissue_preparation.py
└── README.md (this file)
```

## Contributors

- Johanna Schaffenrath
- Cankun Wang
- Shaohong Feng

For questions or feedback, contact Sizun Jiang: sjiang3@bidmc.harvard.edu.
